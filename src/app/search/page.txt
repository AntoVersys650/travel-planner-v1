'use client';

import React, { useState, useEffect, useRef } from 'react';
import { useSearchParams, useRouter } from 'next/navigation';
import { format } from 'date-fns';
import { it } from 'date-fns/locale';
import {
    FaMapMarkerAlt,
    FaUsers,
    FaChild,
    FaPaw,
    FaMoneyBillWave
} from 'react-icons/fa';
import {  } from 'lucide-react'; // Removed Group
import { Users } from 'lucide-react'; // Added Users
import { ChevronDown } from 'lucide-react';
import { Popover, PopoverTrigger, PopoverContent } from '@radix-ui/react-popover';
import Button from 'src/app/components/ui/button';
import Input from 'src/app/components/ui/input';
import { cn } from '@/lib/utils';
import 'react-datepicker/dist/react-datepicker.css';
import { CalendarIcon } from 'lucide-react';
import DatePicker, { registerLocale } from 'react-datepicker';
registerLocale('it', it);
import HeaderComponent from 'src/app/components/Header';

// Mock suggestions generator
type Suggestion = string;
const generateTravelSuggestions = async (): Promise<Suggestion[]> => {
    await new Promise(res => setTimeout(res, 1000));
    return ['Suggerimento 1', 'Suggerimento 2', 'Suggerimento 3'];
};

// GuestsPicker component
const GuestsPicker = ({
    adults,
    children,
    animals,
    setAdults,
    setChildren,
    setAnimals,
    onClose,
    translations
}: {
    adults: number;
    children: number;
    animals: number;
    setAdults: (n: number) => void;
    setChildren: (n: number) => void;
    setAnimals: (n: number) => void;
    onClose: () => void;
    translations: Record<string, string>;
}) => {
    return (
        <div className="p-4 bg-white rounded-lg shadow-lg w-72 space-y-4">
            {[
                { icon: FaUsers, label: translations.adults, value: adults, setter: setAdults, min: 1 },
                { icon: FaChild, label: translations.children, value: children, setter: setChildren, min: 0 },
                { icon: FaPaw, label: translations.pets, value: animals, setter: setAnimals, min: 0 }
            ].map(({ icon: Icon, label, value, setter, min }, i) => (
                <div key={i} className="flex items-center justify-between">
                    <div className="flex items-center gap-2">
                        <Icon className="w-5 h-5 text-gray-600" />
                        <span>{label}</span>
                    </div>
                    <div className="flex items-center gap-2">
                        <Button size="icon" variant="outline" onClick={() => setter(Math.max(min, value - 1))}>-</Button>
                        <span>{value}</span>
                        <Button size="icon" variant="outline" onClick={() => setter(value + 1)}>+</Button>
                    </div>
                </div>
            ))}
            <Button className="w-full mt-4" onClick={onClose}>
                {translations.confirm}
            </Button>
        </div>
    );
};

const CalendarComponent: React.FC<{
    selected: Date | undefined;
    onSelect: (date: Date | undefined) => void;
    placeholder: string;
    className?: string;
    minDate?: Date;
    maxDate?: Date;
}> = ({ selected, onSelect, placeholder, className, minDate, maxDate }) => {
    const [inputWidth, setInputWidth] = useState<string>('100%');
    const inputRef = useRef<HTMLButtonElement>(null);


    useEffect(() => {
        const updateWidth = () => {
            if (typeof window !== 'undefined') {
                const parentElement = document.querySelector('.date-input-container');
                if (parentElement) {
                    const width = parentElement.getBoundingClientRect().width;
                    setInputWidth(`${width}px`);
                } else {
                    setInputWidth('100%');
                }
            }
        };

        updateWidth();
        window.addEventListener('resize', updateWidth);

        return () => {
            window.removeEventListener('resize', updateWidth);
        };
    }, []);

    const formatDate = (date: Date | undefined) => {
        if (!date) return placeholder;
        return format(date, 'dd/MM/yyyy', { locale: it });
    };

    const CustomInput = React.forwardRef<HTMLInputElement, { value?: string; onClick?: () => void; placeholder: string }>(
        ({ value, onClick, placeholder: customPlaceholder }, ref) => (
            <Button
                variant="outline"
                ref={ref as any}
                onClick={onClick}
                className={cn(
                    "w-full justify-start text-left font-normal flex items-center",
                    !value && 'text-muted-foreground',
                    className
                )}
                style={{ width: inputWidth }}

            >
                <CalendarIcon className="mr-2 h-4 w-4" />
                {value || customPlaceholder}
            </Button>
        )
    );
    CustomInput.displayName = 'CustomInput';

    return (
        <DatePicker
            selected={selected}
            onChange={onSelect}
            dateFormat="dd/MM/yyyy"
            placeholderText={placeholder}
            minDate={minDate}
            maxDate={maxDate}
            locale="it"
            customInput={<CustomInput placeholder={placeholder} />}
            className="w-full"
        />
    );
};

export default function SearchPage() {
    const params = useSearchParams();
    const router = useRouter();
    const q = params.get('q') || '';
    const cIn = params.get('checkIn');
    const cOut = params.get('checkOut');
    const gP = params.get('guests') || '1,0,0';
    const minB = params.get('minBudget') || '0';
    const maxB = params.get('maxBudget') || '10000';

    const [location, setLocation] = useState(q);
    const [checkInDate, setCheckInDate] = useState<Date | null>(cIn ? new Date(cIn) : null);
    const [checkOutDate, setCheckOutDate] = useState<Date | null>(cOut ? new Date(cOut) : null);
    const [adults, setAdults] = useState(1);
    const [children, setChildren] = useState(0);
    const [animals, setAnimals] = useState(0);
    const [minBudget, setMinBudget] = useState<number>(parseInt(minB, 10));
    const [maxBudget, setMaxBudget] = useState<number>(parseInt(maxB, 10));
    const [suggestions, setSuggestions] = useState<Suggestion[]>([]);
    const [loading, setLoading] = useState(false);
    const [showGuests, setShowGuests] = useState(false);
    const containerRef = useRef<HTMLDivElement>(null);
    const [inputWidth, setInputWidth] = useState<string>('100%');
    const [checkInOutWidth, setCheckInOutWidth] = useState<string>('48.5%');
    const [formAlignment, setFormAlignment] = useState<'left' | 'center' | 'right'>('left');
    const [isClient, setIsClient] = useState(false);
    const today = new Date();
    const [currency, setCurrency] = useState('€'); // Default currency, get from Header
    const headerRef = useRef<HTMLElement>(null);
    const [headerHeight, setHeaderHeight] = useState(0);
    const [headerOffset, setHeaderOffset] = useState(110); // Corrected header offset
    //const headerOffset = 80; // Fixed header offset - Now using state


    const translationsSet = {
        guests: 'Ospiti',
        adults: 'Adulti',
        children: 'Bambini',
        pets: 'Animali',
        confirm: 'Conferma',
        searchTitle: 'Risultati',
        travelSuggestionsTitle: 'Suggerimenti di Viaggio'
    };

     useEffect(() => {
        if (headerRef.current) {
            setHeaderHeight(headerRef.current.offsetHeight);
        }
    }, []);

    useEffect(() => {
        setIsClient(typeof window !== 'undefined');
        const [a, c, an] = gP.split(',').map(Number);
        setAdults(a);
        setChildren(c);
        setAnimals(an);
    }, [gP]);

    useEffect(() => {
        if (!q) router.push('/');
    }, [q, router]);

    useEffect(() => {
        const updateWidth = () => {
            if (containerRef.current) {
                const containerWidth = containerRef.current.offsetWidth;
                setInputWidth(`${containerWidth}px`);
                setCheckInOutWidth(`${(containerWidth - 24) / 2}px`);
            }
        };

        updateWidth();
        window.addEventListener('resize', updateWidth);

        return () => {
            window.removeEventListener('resize', updateWidth);
        };
    }, []);

      useEffect(() => {
        // Get currency from localStorage (or default to '€')
        const storedCurrency = typeof window !== 'undefined' ? localStorage.getItem('selectedCurrency') : null;
        if (storedCurrency) {
            setCurrency(storedCurrency);
        }
    }, []);


    useEffect(() => {
        setLoading(true);
        generateTravelSuggestions().then(res => {
            setSuggestions(res);
            setLoading(false);
        });
    }, [location, checkInDate, checkOutDate, adults, children, animals, minBudget, maxBudget]);



    if (!isClient) return <div>Loading...</div>;

    return (
        <div className="min-h-screen bg-gray-50">
            <HeaderComponent ref={headerRef} onCurrencyChange={setCurrency}/>
            <div className="flex flex-col md:flex-row" style={{ marginTop: `${headerHeight + headerOffset}px` }} ref={containerRef}>
                <div
                    className={cn(
                        "md:w-1/3 p-6 bg-white rounded shadow space-y-6",
                        formAlignment === 'left' && 'mr-auto',
                        formAlignment === 'center' && 'mx-auto',
                        formAlignment === 'right' && 'ml-auto'
                    )}
                    style={{
                        marginLeft: formAlignment === 'left' ? '0' : undefined,
                        marginRight: formAlignment === 'right' ? '0' : undefined,
                        margin: formAlignment === 'center' ? '0 auto' : undefined
                    }}
                >
                    {/* Località */}
                    <div>
                        <label className="block text-sm font-medium">Destinazione</label>
                        <div className="relative mt-1">
                            <FaMapMarkerAlt className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                            <Input
                                value={location}
                                onChange={e => setLocation(e.target.value)}
                                className="pl-10 w-full"
                                placeholder="Località"

                            />
                        </div>
                    </div>

                    {/* Check-in e Check-out */}
                    <div className="flex justify-between gap-4">
                        <div className="date-input-container" style={{ width: checkInOutWidth }}>
                            <label className="block text-sm font-medium">Check-in</label>
                            <CalendarComponent
                                selected={checkInDate}
                                onSelect={setCheckInDate}
                                placeholder="Check-in"
                                minDate={today}
                                className="w-full"
                            />
                        </div>
                        <div className="date-input-container" style={{ width: checkInOutWidth }}>
                            <label className="block text-sm font-medium">Check-out</label>
                            <CalendarComponent
                                selected={checkOutDate}
                                onSelect={setCheckOutDate}
                                placeholder="Check-out"
                                minDate={checkInDate || today}
                                className="w-full"
                            />
                        </div>
                    </div>

                    {/* Ospiti */}
                    <div>
                        <label className="block text-sm font-medium">{translationsSet.guests}</label>
                        <div className="relative mt-1">
                            <Users className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 z-10" /> {/* Replaced Group with Users */}
                            <Popover open={showGuests} onOpenChange={setShowGuests}>
                                <PopoverTrigger asChild>
                                    <div className="relative w-full">
                                        <Input
                                            readOnly
                                            value={`${adults} ${translationsSet.adults}, ${children} ${translationsSet.children}, ${animals} ${translationsSet.pets}`}
                                            placeholder={translationsSet.guests}
                                            className="pl-10 cursor-pointer w-full"
                                        />
                                        <ChevronDown className="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none" />
                                    </div>
                                </PopoverTrigger>
                                <PopoverContent sideOffset={5} className="p-0 z-50 mt-1">
                                    <GuestsPicker
                                        adults={adults}
                                        children={children}
                                        animals={animals}
                                        setAdults={setAdults}
                                        setChildren={setChildren}
                                        setAnimals={setAnimals}
                                        onClose={() => setShowGuests(false)}
                                        translations={translationsSet}
                                    />
                                </PopoverContent>
                            </Popover>
                        </div>
                    </div>

                    {/* Budget */}
                    <div className="flex justify-between gap-4">
                        <div className="date-input-container" style={{ width: checkInOutWidth }}>
                            <label className="block text-sm font-medium">Budget Minimo</label>
                            <div className="relative mt-1">
                                <FaMoneyBillWave className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                                <Input
                                    type="number"
                                    value={minBudget}
                                    onChange={e => setMinBudget(+e.target.value)}
                                    className="pl-10 w-full"
                                    placeholder={`Min (${currency})`}
                                />
                            </div>
                        </div>
                        <div className="date-input-container" style={{ width: checkInOutWidth }}>
                            <label className="block text-sm font-medium">Budget Massimo</label>
                            <div className="relative mt-1">
                                <FaMoneyBillWave className="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500" />
                                <Input
                                    type="number"
                                    value={maxBudget}
                                    onChange={e => setMaxBudget(+e.target.value)}
                                    className="pl-10 w-full"
                                    placeholder={`Max (${currency})`}
                                />
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-center">
                        <Button
                            className="bg-blue-500 text-white w-full"
                            onClick={() => router.push(
                                `/search?q=${location}` +
                                `${checkInDate ? `&checkIn=${format(checkInDate, 'yyyy-MM-dd')}` : ''}` +
                                `${checkOutDate ? `&checkOut=${format(checkOutDate, 'yyyy-MM-dd')}` : ''}` +
                                `&guests=${adults},${children},${animals}` +
                                `&minBudget=${minBudget}&maxBudget=${maxBudget}`
                            )}
                        >
                            Cerca
                        </Button>
                    </div>
                </div>
                {/* Results */}
                <div className="md:w-2/3 p-6">
                    <h2 className="text-2xl font-bold mb-4">{translationsSet.searchTitle}</h2>
                    <h3 className="text-xl font-semibold mb-2">{translationsSet.travelSuggestionsTitle}</h3>
                    {loading ? <p>Generazione in corso...</p> : (
                        <ul className="list-disc list-inside space-y-2">
                            {suggestions.map((s, i) => <li key={i}>{s}</li>)}
                        </ul>
                    )}
                </div>
            </div>
        </div>
    );

